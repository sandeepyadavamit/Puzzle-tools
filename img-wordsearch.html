<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Word Search Book Creator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --warning: #f72585;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        h1 {
            font-family: 'Fredoka One', cursive;
            font-size: 2.5rem;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }
        
        .tagline {
            font-weight: 300;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
        }
        
        .controls-panel {
            flex: 1;
            min-width: 300px;
            padding: 20px;
            background: var(--light);
            border-radius: 10px;
            margin-right: 20px;
            margin-bottom: 20px;
        }
        
        .preview-panel {
            flex: 2;
            min-width: 400px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .control-group {
            margin-bottom: 25px;
        }
        
        .control-group h3 {
            font-size: 1.2rem;
            color: var(--secondary);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--accent);
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        select, input[type="number"], input[type="text"], input[type="file"], textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
            transition: border 0.3s;
        }
        
        select:focus, input:focus, textarea:focus {
            border-color: var(--accent);
            outline: none;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .file-upload {
            position: relative;
            margin-bottom: 20px;
        }
        
        .file-upload-btn {
            display: block;
            width: 100%;
            padding: 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .file-upload-btn:hover {
            background: var(--primary);
        }
        
        .choose-topics-btn {
            display: block;
            width: 100%;
            padding: 8px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s;
            margin-bottom: 15px;
        }
        
        .choose-topics-btn:hover {
            background: #3ab0d9;
        }
        
        .file-name {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .word-list-preview {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            border: 1px dashed #ccc;
            max-height: 100px;
            overflow-y: auto;
        }
        
        .word-list-preview span {
            display: inline-block;
            background: #e9ecef;
            padding: 3px 8px;
            margin: 3px;
            border-radius: 15px;
            font-size: 0.85rem;
        }
        
        .action-btns {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            text-align: center;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn-secondary:hover {
            background: #f0f4ff;
            transform: translateY(-2px);
        }
        
        .page-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .puzzle-title {
            font-size: 1.3rem;
            color: var(--secondary);
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .puzzle-topic {
            font-size: 1rem;
            color: var(--accent);
            text-align: center;
            margin-bottom: 15px;
            font-style: italic;
        }
        
        .wordsearch-grid {
            display: grid;
            gap: 2px;
            margin: 20px auto;
        }
        
        .wordsearch-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background: #f8f9fa;
            border-radius: 3px;
            font-size: 0.9rem;
            position: relative;
        }
        
        /* Black and white solution highlights */
        .solution-highlight {
            position: absolute;
            width: 80%;
            height: 80%;
            border-radius: 50%;
            z-index: 1;
            background-color: rgba(0, 0, 0, 0.1);
            border: 1px solid #333;
        }
        
        /* Direction indicators for B&W */
        .dir-start {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: black;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            z-index: 2;
        }
        
        .dir-end {
            position: absolute;
            width: 6px;
            height: 6px;
            border: 1px solid black;
            border-radius: 50%;
            bottom: 2px;
            right: 2px;
            z-index: 2;
        }
        
        .word-list {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        
        .solution-page {
            background: #f0f7ff;
            border-left: 5px solid var(--accent);
        }
        
        .status-message {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }
        
        .grid-size-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .grid-size-controls div {
            flex: 1;
        }
        
        .solution-layout {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .solution-option {
            flex: 1;
            text-align: center;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .solution-option.selected {
            border-color: var(--accent);
            background-color: #f0f4ff;
        }
        
        .direction-dropdown {
            width: 100%;
            margin-bottom: 15px;
        }
        
        .direction-dropdown select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: var(--secondary);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark);
        }
        
        .search-topics {
            margin-bottom: 15px;
        }
        
        .topic-categories {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .topic-category {
            padding: 12px;
            background: #f0f4ff;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .topic-category:hover {
            background: var(--accent);
            color: white;
        }
        
        .topic-category.selected {
            background: var(--secondary);
            color: white;
        }
        
        .word-count-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .word-count-control input {
            flex: 1;
        }
        
        .generate-words-action {
            text-align: center;
        }
        
        .solution-key {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
            font-size: 0.8rem;
        }
        
        .direction-key {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .direction-indicator {
            width: 15px;
            height: 15px;
            position: relative;
        }
        
        .direction-indicator .start {
            position: absolute;
            width: 6px;
            height: 6px;
            background-color: black;
            border-radius: 50%;
            top: 0;
            left: 0;
        }
        
        .direction-indicator .end {
            position: absolute;
            width: 4px;
            height: 4px;
            border: 1px solid black;
            border-radius: 50%;
            bottom: 0;
            right: 0;
        }

        /* Cover Page Styles */
        .cover-page {
            margin-bottom: 20px;
            background: linear-gradient(to bottom right, #fefefe, #e0f7fa);
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }

        .cover-title {
            font-size: 2.5rem;
            color: #00796b;
            margin-bottom: 0.5em;
            font-family: 'Fredoka One', cursive;
        }

        .cover-subtitle {
            font-size: 1.8rem;
            color: #004d40;
            margin-bottom: 1em;
        }

        .cover-description {
            font-size: 1.2rem;
            max-width: 700px;
            margin: 0 auto 2em auto;
            color: #444;
        }

        .cover-features {
            text-align: left;
            margin: 0 auto 2em auto;
            max-width: 500px;
        }

        .cover-features li {
            font-size: 1.1rem;
            margin: 0.5em 0;
            line-height: 1.4;
        }

        .cover-footer {
            font-size: 1rem;
            color: #777;
        }

        .puzzle-banner {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
        }

        .puzzle-banner img {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .controls-panel {
                margin-right: 0;
            }
            
            .grid-size-controls {
                flex-direction: column;
            }
            
            .topic-categories {
                grid-template-columns: 1fr;
            }

            .cover-title {
                font-size: 2rem;
            }

            .cover-subtitle {
                font-size: 1.4rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>Ultimate Word Search Book Creator</h1>
            <p class="tagline">Create printable word search books with solutions</p>
        </header>
        
        <div class="main-content">
            <div class="controls-panel">
                <div class="control-group">
                    <h3>Puzzle Settings</h3>
                    
                    <div class="grid-size-controls">
                        <div>
                            <label for="gridRows">Number of Rows</label>
                            <input type="number" id="gridRows" min="5" max="20" value="12">
                        </div>
                        <div>
                            <label for="gridCols">Number of Columns</label>
                            <input type="number" id="gridCols" min="5" max="20" value="12">
                        </div>
                    </div>
                    
                    <label for="wordsPerPuzzle">Words Per Puzzle</label>
                    <input type="number" id="wordsPerPuzzle" min="5" max="20" value="10">
                    
                    <label>Allowed Word Directions</label>
                    <div class="direction-dropdown">
                        <select id="directionSelect" multiple>
                            <option value="0" selected>↑ Up</option>
                            <option value="1" selected>↗ Up-Right</option>
                            <option value="2" selected>→ Right</option>
                            <option value="3" selected>↘ Down-Right</option>
                            <option value="4" selected>↓ Down</option>
                            <option value="5" selected>↙ Down-Left</option>
                            <option value="6" selected>← Left</option>
                            <option value="7" selected>↖ Up-Left</option>
                        </select>
                    </div>
                    
                    <label>Difficulty Level</label>
                    <select id="difficulty">
                        <option value="easy">Easy (More words placed)</option>
                        <option value="medium" selected>Medium (Balanced)</option>
                        <option value="hard">Hard (Fewer words placed)</option>
                    </select>
                    
                    <label>Solution Page Layout</label>
                    <div class="solution-layout">
                        <div class="solution-option selected" data-layout="single">
                            <span>1 Solution Per Page</span>
                        </div>
                        <div class="solution-option" data-layout="double">
                            <span>2 Solutions Per Page</span>
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>Word List</h3>
                    <div class="file-upload">
                        <input type="file" id="wordFile" accept=".txt" style="display: none;">
                        <button class="file-upload-btn" id="uploadBtn">Upload Word List (.txt)</button>
                        <div class="file-name" id="fileName">No file selected</div>
                    </div>
                    
                    <button class="choose-topics-btn" id="chooseTopicsBtn">Choose Topics</button>
                    
                    <label for="customTopics">Puzzle Topics (Separate with commas for different topics)</label>
                    <textarea id="customTopics" placeholder="Animals, Countries, Food, Sports\nOr type one topic for all puzzles"></textarea>
                    
                    <div class="word-list-preview" id="wordListPreview">
                        <div id="defaultWordsText">Default words will be used</div>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>Book Settings</h3>
                    <label for="pageSize">Page Size</label>
                    <select id="pageSize">
                        <option value="6x9" selected>6" x 9" (Standard)</option>
                        <option value="8.5x11">8.5" x 11" (Letter)</option>
                        <option value="a4">A4</option>
                    </select>
                    
                    <label for="puzzleCount">Number of Puzzles</label>
                    <input type="number" id="puzzleCount" min="1" max="50" value="10">
                    
                    <label for="bookTitle">Book Title</label>
                    <input type="text" id="bookTitle" value="High-Frequency Words Puzzle Book">
                    
                    <label for="bookSubtitle">Book Subtitle</label>
                    <input type="text" id="bookSubtitle" value="Fun Word Search Puzzles for Students">
                    
                    <label for="bookAuthor">Author/Creator</label>
                    <input type="text" id="bookAuthor" value="Your Name">
                </div>
                
                <div class="action-btns">
                    <button class="btn btn-primary" id="generateBtn">Generate Puzzles</button>
                    <button class="btn btn-secondary" id="exportPdfBtn">Export to PDF</button>
                </div>
            </div>
            
            <div class="preview-panel">
                <h2>Book Preview</h2>
                <div id="bookPreview">
                    <div class="status-message">
                        <p>Your word search book will appear here after generation</p>
                        <p>Click "Generate Puzzles" to begin</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Topics Modal -->
    <div class="modal" id="topicsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Choose Topics</h3>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            
            <div class="control-group">
                <div class="search-topics">
                    <input type="text" id="topicSearch" placeholder="Search topics...">
                </div>
                
                <h3>Popular Categories</h3>
                <div class="topic-categories">
                    <div class="topic-category" data-category="animals">Animals</div>
                    <div class="topic-category" data-category="nature">Nature</div>
                    <div class="topic-category" data-category="food">Food & Drink</div>
                    <div class="topic-category" data-category="sports">Sports</div>
                    <div class="topic-category" data-category="science">Science</div>
                    <div class="topic-category" data-category="music">Music</div>
                    <div class="topic-category" data-category="movies">Movies & TV</div>
                    <div class="topic-category" data-category="technology">Technology</div>
                    <div class="topic-category" data-category="travel">Travel</div>
                    <div class="topic-category" data-category="history">History</div>
                    <div class="topic-category" data-category="art">Art & Literature</div>
                    <div class="topic-category" data-category="hobbies">Hobbies</div>
                </div>
                
                <div class="word-count-control">
                    <label for="generatedWordCount">Number of Words:</label>
                    <input type="number" id="generatedWordCount" min="5" max="100" value="20">
                </div>
                
                <div class="generate-words-action">
                    <button class="btn btn-primary" id="generateFromTopicsBtn">Generate Words</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        
        // App state
        let customWords = [];
        let generatedPuzzles = [];
        let customTopics = [];
        let solutionLayout = "single"; // 'single' or 'double'
        let allowedDirections = [0,1,2,3,4,5,6,7]; // All directions initially
        let difficulty = "medium";
        
        // Word banks by category
        const WORD_BANKS = {
            animals: ["LION", "TIGER", "ELEPHANT", "GIRAFFE", "ZEBRA", "KANGAROO", "PANDA", "CHEETAH", "RHINOCEROS", "HIPPOPOTAMUS"],
            nature: ["FOREST", "MOUNTAIN", "OCEAN", "RIVER", "DESERT", "VALLEY", "WATERFALL", "VOLCANO", "GLACIER", "CAVE"],
            food: ["PIZZA", "PASTA", "SUSHI", "BURGER", "SALAD", "STEAK", "TACO", "CHEESE", "CHOCOLATE", "ICE CREAM"],
            sports: ["FOOTBALL", "BASKETBALL", "BASEBALL", "SOCCER", "TENNIS", "GOLF", "HOCKEY", "CRICKET", "RUGBY", "SWIMMING"],
            science: ["CHEMISTRY", "BIOLOGY", "PHYSICS", "ASTRONOMY", "GEOLOGY", "BOTANY", "ZOOLOGY", "GENETICS", "ECOLOGY", "METEOROLOGY"],
            music: ["GUITAR", "PIANO", "VIOLIN", "DRUMS", "TRUMPET", "FLUTE", "HARMONICA", "SAXOPHONE", "CELLO", "TROMBONE"],
            movies: ["ACTION", "COMEDY", "DRAMA", "HORROR", "SCIENCE FICTION", "ROMANCE", "THRILLER", "DOCUMENTARY", "ANIMATION", "FANTASY"],
            technology: ["COMPUTER", "SMARTPHONE", "TABLET", "LAPTOP", "INTERNET", "SOFTWARE", "HARDWARE", "PROGRAMMING", "ARTIFICIAL INTELLIGENCE", "ROBOTICS"],
            travel: ["PASSPORT", "AIRPORT", "HOTEL", "BEACH", "MOUNTAIN", "CITY", "COUNTRY", "CULTURE", "ADVENTURE", "BACKPACK"],
            history: ["PYRAMID", "COLOSSEUM", "GREAT WALL", "ACROPOLIS", "MACHU PICCHU", "ANGKOR WAT", "TAJ MAHAL", "STONEHENGE", "PETRA", "CHICHEN ITZA"],
            art: ["PAINTING", "SCULPTURE", "PHOTOGRAPHY", "MUSEUM", "GALLERY", "PORTRAIT", "LANDSCAPE", "ABSTRACT", "IMPRESSIONISM", "SURREALISM"],
            hobbies: ["GARDENING", "COOKING", "PHOTOGRAPHY", "PAINTING", "READING", "FISHING", "HIKING", "KNITTING", "CHESS", "DANCING"]
        };
        
        // Default words
        const DEFAULT_WORDS = [
            'PUZZLE', 'SEARCH', 'SOLUTION', 'AMAZON', 'KDP', 
            'BOOK', 'AUTHOR', 'PUBLISH', 'WORD', 'FIND',
            'GRID', 'LETTER', 'HIDDEN', 'SOLVE', 'FUN',
            'BRAIN', 'GAME', 'CHALLENGE', 'LEARN', 'EDUCATION'
        ];
        
        // Default topics
        const DEFAULT_TOPICS = [
            'Animals', 'Countries', 'Food', 'Sports', 
            'Science', 'Music', 'Movies', 'Technology'
        ];
        
        // DOM elements
        const wordFileInput = document.getElementById('wordFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileName = document.getElementById('fileName');
        const wordListPreview = document.getElementById('wordListPreview');
        const defaultWordsText = document.getElementById('defaultWordsText');
        const generateBtn = document.getElementById('generateBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const bookPreview = document.getElementById('bookPreview');
        const customTopicsInput = document.getElementById('customTopics');
        const wordsPerPuzzleInput = document.getElementById('wordsPerPuzzle');
        const gridRowsInput = document.getElementById('gridRows');
        const gridColsInput = document.getElementById('gridCols');
        const solutionOptions = document.querySelectorAll('.solution-option');
        const directionSelect = document.getElementById('directionSelect');
        const difficultySelect = document.getElementById('difficulty');
        const topicsModal = document.getElementById('topicsModal');
        const chooseTopicsBtn = document.getElementById('chooseTopicsBtn');
        const closeModalBtn = document.getElementById('closeModal');
        const generateFromTopicsBtn = document.getElementById('generateFromTopicsBtn');
        const topicCategories = document.querySelectorAll('.topic-category');
        const generatedWordCountInput = document.getElementById('generatedWordCount');
        const topicSearchInput = document.getElementById('topicSearch');
        const bookTitleInput = document.getElementById('bookTitle');
        const bookSubtitleInput = document.getElementById('bookSubtitle');
        const bookAuthorInput = document.getElementById('bookAuthor');
        
        // Event listeners
        uploadBtn.addEventListener('click', () => wordFileInput.click());
        wordFileInput.addEventListener('change', handleFileUpload);
        generateBtn.addEventListener('click', generatePuzzles);
        exportPdfBtn.addEventListener('click', exportToPdf);
        chooseTopicsBtn.addEventListener('click', () => topicsModal.style.display = 'flex');
        closeModalBtn.addEventListener('click', () => topicsModal.style.display = 'none');
        generateFromTopicsBtn.addEventListener('click', generateWordsFromTopics);
        
        // Update allowed directions when dropdown changes
        directionSelect.addEventListener('change', function() {
            allowedDirections = Array.from(this.selectedOptions)
                .map(option => parseInt(option.value));
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === topicsModal) {
                topicsModal.style.display = 'none';
            }
        });
        
        // Topic search functionality
        topicSearchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            topicCategories.forEach(category => {
                const categoryText = category.textContent.toLowerCase();
                if (categoryText.includes(searchTerm)) {
                    category.style.display = 'block';
                } else {
                    category.style.display = 'none';
                }
            });
        });
        
        // Solution layout selection
        solutionOptions.forEach(option => {
            option.addEventListener('click', () => {
                solutionOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                solutionLayout = option.dataset.layout;
            });
        });
        
        // Difficulty selection
        difficultySelect.addEventListener('change', function() {
            difficulty = this.value;
        });
        
        // Topic category selection
        topicCategories.forEach(category => {
            category.addEventListener('click', function() {
                this.classList.toggle('selected');
            });
        });
        
        // File upload handler
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            fileName.textContent = file.name;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                customWords = event.target.result.split('\n')
                    .map(word => word.trim().toUpperCase())
                    .filter(word => word.length > 0);
                
                updateWordListPreview();
            };
            reader.readAsText(file);
        }
        
        // Generate words from selected topics
        function generateWordsFromTopics() {
            const selectedCategories = Array.from(document.querySelectorAll('.topic-category.selected'))
                .map(el => el.dataset.category);
            
            if (selectedCategories.length === 0) {
                alert('Please select at least one category');
                return;
            }
            
            const wordCount = parseInt(generatedWordCountInput.value);
            const wordsPerCategory = Math.ceil(wordCount / selectedCategories.length);
            let generatedWords = [];
            
            selectedCategories.forEach(category => {
                const categoryWords = [...WORD_BANKS[category]];
                const shuffled = categoryWords.sort(() => 0.5 - Math.random());
                generatedWords.push(...shuffled.slice(0, wordsPerCategory));
            });
            
            // Shuffle and trim to exact count
            generatedWords = generatedWords
                .sort(() => 0.5 - Math.random())
                .slice(0, wordCount);
            
            // Update the word list
            customWords = generatedWords;
            updateWordListPreview();
            
            // Close the modal
            topicsModal.style.display = 'none';
            
            // Clear selections
            topicCategories.forEach(cat => cat.classList.remove('selected'));
            topicSearchInput.value = '';
        }
        
        // Update word list preview
        function updateWordListPreview() {
            const wordsToShow = customWords.length > 0 ? customWords : DEFAULT_WORDS;
            const previewCount = Math.min(wordsToShow.length, 15);
            
            wordListPreview.innerHTML = '';
            
            if (customWords.length === 0) {
                defaultWordsText.style.display = 'block';
            } else {
                defaultWordsText.style.display = 'none';
                
                for (let i = 0; i < previewCount; i++) {
                    const wordEl = document.createElement('span');
                    wordEl.textContent = wordsToShow[i];
                    wordListPreview.appendChild(wordEl);
                }
                
                if (wordsToShow.length > previewCount) {
                    const moreEl = document.createElement('span');
                    moreEl.textContent = `+${wordsToShow.length - previewCount} more`;
                    wordListPreview.appendChild(moreEl);
                }
            }
        }
        
        // Parse custom topics
        function parseCustomTopics() {
            const topicsText = customTopicsInput.value.trim();
            if (!topicsText) {
                customTopics = [];
                return;
            }
            
            // Check if there are commas (multiple topics)
            if (topicsText.includes(',')) {
                customTopics = topicsText.split(',')
                    .map(topic => topic.trim())
                    .filter(topic => topic.length > 0);
            } else {
                // Single topic for all puzzles
                const puzzleCount = parseInt(document.getElementById('puzzleCount').value);
                customTopics = Array(puzzleCount).fill(topicsText);
            }
        }
        
        // Word Search Generator
        function generateWordSearch(words, topic, rows, cols) {
            const grid = Array(rows).fill().map(() => Array(cols).fill(''));
            const placedWords = [];
            
            // Adjust difficulty
            let maxAttempts;
            switch(difficulty) {
                case 'easy': maxAttempts = 200; break;
                case 'hard': maxAttempts = 50; break;
                default: maxAttempts = 100; // medium
            }
            
            // Place words
            words.forEach(word => {
                // Skip words that are too long for the grid
                if (word.length > Math.max(rows, cols)) return;
                
                let placed = false;
                let attempts = 0;
                
                while (!placed && attempts < maxAttempts) {
                    const dir = allowedDirections[Math.floor(Math.random() * allowedDirections.length)];
                    const row = Math.floor(Math.random() * rows);
                    const col = Math.floor(Math.random() * cols);
                    
                    if (canPlaceWord(grid, word, row, col, dir, rows, cols)) {
                        const placedWord = placeWord(grid, word, row, col, dir);
                        placedWords.push(placedWord);
                        placed = true;
                    }
                    attempts++;
                }
            });
            
            // Fill empty spaces
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    if (grid[i][j] === '') {
                        grid[i][j] = letters[Math.floor(Math.random() * letters.length)];
                    }
                }
            }
            
            return {
                grid: grid,
                words: words,
                topic: topic || null, // Set to null if no topic
                placedWords: placedWords,
                rows: rows,
                cols: cols
            };
        }
        
        function canPlaceWord(grid, word, row, col, dir, maxRows, maxCols) {
            const dx = [0, 1, 1, 1, 0, -1, -1, -1][dir];
            const dy = [-1, -1, 0, 1, 1, 1, 0, -1][dir];
            
            for (let i = 0; i < word.length; i++) {
                const newRow = row + i * dy;
                const newCol = col + i * dx;
                
                if (newRow < 0 || newRow >= maxRows || newCol < 0 || newCol >= maxCols) {
                    return false;
                }
                
                if (grid[newRow][newCol] !== '' && grid[newRow][newCol] !== word[i]) {
                    return false;
                }
            }
            
            return true;
        }
        
        function placeWord(grid, word, row, col, dir) {
            const dx = [0, 1, 1, 1, 0, -1, -1, -1][dir];
            const dy = [-1, -1, 0, 1, 1, 1, 0, -1][dir];
            
            const placedWord = {
                word: word,
                startRow: row,
                startCol: col,
                direction: dir,
                letters: []
            };
            
            for (let i = 0; i < word.length; i++) {
                const newRow = row + i * dy;
                const newCol = col + i * dx;
                grid[newRow][newCol] = word[i];
                
                placedWord.letters.push({
                    row: newRow,
                    col: newCol,
                    direction: dir,
                    isFirst: i === 0,
                    isLast: i === word.length - 1
                });
            }
            
            return placedWord;
        }
        
        // Create cover page
        function createCoverPage() {
            const cover = document.createElement('div');
            cover.className = 'page-preview cover-page';
            
            const title = document.createElement('h1');
            title.className = 'cover-title';
            title.textContent = bookTitleInput.value;
            cover.appendChild(title);
            
            const subtitle = document.createElement('h2');
            subtitle.className = 'cover-subtitle';
            subtitle.textContent = bookSubtitleInput.value;
            cover.appendChild(subtitle);
            
            const description = document.createElement('div');
            description.className = 'cover-description';
            description.textContent = 'Boost vocabulary, improve spelling, and enjoy learning with this engaging collection of interactive puzzles. Perfect for home, classroom, or learning centers.';
            cover.appendChild(description);
            
            const features = document.createElement('div');
            features.className = 'cover-features';
            
            const featureList = document.createElement('ul');
            featureList.innerHTML = `
                <li>✔ ${customWords.length > 0 ? customWords.length : DEFAULT_WORDS.length} carefully selected words</li>
                <li>✔ Includes word searches with solutions</li>
                <li>✔ Student-friendly layout and fun design</li>
                <li>✔ Printable and digital-friendly format</li>
                <li>✔ Enhances reading, writing, and vocabulary skills</li>
            `;
            features.appendChild(featureList);
            cover.appendChild(features);
            
            const banner = document.createElement('div');
            banner.className = 'puzzle-banner';
            banner.innerHTML = '<img src="https://cdn.pixabay.com/photo/2015/10/31/12/41/puzzle-1018877_960_720.jpg" alt="Puzzle Theme">';
            cover.appendChild(banner);
            
            const footer = document.createElement('div');
            footer.className = 'cover-footer';
            const currentYear = new Date().getFullYear();
            footer.textContent = `Created by ${bookAuthorInput.value} · © ${currentYear}`;
            cover.appendChild(footer);
            
            return cover;
        }
        
        // Render Word Search
        function renderWordSearch(puzzle, puzzleNumber) {
            const container = document.createElement('div');
            container.className = 'page-preview';
            
            const title = document.createElement('div');
            title.className = 'puzzle-title';
            title.textContent = `Word Search #${puzzleNumber}`;
            container.appendChild(title);
            
            // Only show topic if it exists
            if (puzzle.topic) {
                const topic = document.createElement('div');
                topic.className = 'puzzle-topic';
                topic.textContent = `Topic: ${puzzle.topic}`;
                container.appendChild(topic);
            }
            
            const gridElement = document.createElement('div');
            gridElement.className = 'wordsearch-grid';
            gridElement.style.gridTemplateColumns = `repeat(${puzzle.cols}, 1fr)`;
            
            for (let row = 0; row < puzzle.rows; row++) {
                for (let col = 0; col < puzzle.cols; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'wordsearch-cell';
                    cell.textContent = puzzle.grid[row][col];
                    gridElement.appendChild(cell);
                }
            }
            
            container.appendChild(gridElement);
            
            const wordList = document.createElement('div');
            wordList.className = 'word-list';
            const topicText = puzzle.topic ? `${puzzle.topic.toLowerCase()} ` : '';
            wordList.textContent = `Find these ${topicText}words: ${puzzle.words.join(', ')}`;
            container.appendChild(wordList);
            
            return container;
        }
        
        // Create solution pages (single or double)
        function createSolutionPages(puzzles) {
            const pages = [];
            
            if (solutionLayout === 'single') {
                // One solution per page
                puzzles.forEach((puzzle, index) => {
                    const page = document.createElement('div');
                    page.className = 'page-preview solution-page';
                    
                    const header = document.createElement('div');
                    header.className = 'puzzle-title';
                    const topicText = puzzle.topic ? `: ${puzzle.topic}` : '';
                    header.textContent = `Puzzle #${index + 1} Solution${topicText}`;
                    page.appendChild(header);
                    
                    const gridElement = document.createElement('div');
                    gridElement.className = 'wordsearch-grid';
                    gridElement.style.gridTemplateColumns = `repeat(${puzzle.cols}, 1fr)`;
                    
                    // Track which cells are part of solutions
                    const solutionCells = {};
                    puzzle.placedWords.forEach(word => {
                        word.letters.forEach(letter => {
                            const key = `${letter.row}-${letter.col}`;
                            solutionCells[key] = letter;
                        });
                    });
                    
                    for (let row = 0; row < puzzle.rows; row++) {
                        for (let col = 0; col < puzzle.cols; col++) {
                            const cell = document.createElement('div');
                            cell.className = 'wordsearch-cell';
                            cell.textContent = puzzle.grid[row][col];
                            
                            // Add solution highlighting
                            const key = `${row}-${col}`;
                            if (solutionCells[key] !== undefined) {
                                const highlight = document.createElement('div');
                                highlight.className = 'solution-highlight';
                                cell.appendChild(highlight);
                                
                                // Add direction indicators
                                const letter = solutionCells[key];
                                if (letter.isFirst) {
                                    const startDot = document.createElement('div');
                                    startDot.className = 'dir-start';
                                    cell.appendChild(startDot);
                                }
                                if (letter.isLast) {
                                    const endDot = document.createElement('div');
                                    endDot.className = 'dir-end';
                                    cell.appendChild(endDot);
                                }
                            }
                            
                            gridElement.appendChild(cell);
                        }
                    }
                    
                    page.appendChild(gridElement);
                    
                    // Add word list
                    const wordList = document.createElement('div');
                    wordList.className = 'word-list';
                    wordList.innerHTML = `<strong>Words found:</strong><br>${puzzle.words.join(', ')}`;
                    page.appendChild(wordList);
                    
                    // Add direction key
                    const directionKey = document.createElement('div');
                    directionKey.className = 'solution-key';
                    directionKey.innerHTML = `
                        <div class="direction-key">
                            <div class="direction-indicator">
                                <div class="start"></div>
                                <div class="end"></div>
                            </div>
                            <span>Word direction indicators</span>
                        </div>
                        <div>Black dot = word start, Circle = word end</div>
                    `;
                    page.appendChild(directionKey);
                    
                    pages.push(page);
                });
            } else {
                // Two solutions per page
                for (let i = 0; i < puzzles.length; i += 2) {
                    const page = document.createElement('div');
                    page.className = 'page-preview solution-page';
                    
                    // First puzzle
                    if (puzzles[i]) {
                        const puzzle = puzzles[i];
                        
                        const header1 = document.createElement('div');
                        header1.className = 'puzzle-title';
                        const topicText1 = puzzle.topic ? `: ${puzzle.topic}` : '';
                        header1.textContent = `Puzzle #${i+1} Solution${topicText1}`;
                        page.appendChild(header1);
                        
                        const gridElement1 = document.createElement('div');
                        gridElement1.className = 'wordsearch-grid';
                        gridElement1.style.gridTemplateColumns = `repeat(${puzzle.cols}, 1fr)`;
                        gridElement1.style.marginBottom = '30px';
                        
                        const solutionCells1 = {};
                        puzzle.placedWords.forEach(word => {
                            word.letters.forEach(letter => {
                                const key = `${letter.row}-${letter.col}`;
                                solutionCells1[key] = letter;
                            });
                        });
                        
                        for (let row = 0; row < puzzle.rows; row++) {
                            for (let col = 0; col < puzzle.cols; col++) {
                                const cell = document.createElement('div');
                                cell.className = 'wordsearch-cell';
                                cell.textContent = puzzle.grid[row][col];
                                
                                const key = `${row}-${col}`;
                                if (solutionCells1[key] !== undefined) {
                                    const highlight = document.createElement('div');
                                    highlight.className = 'solution-highlight';
                                    cell.appendChild(highlight);
                                    
                                    const letter = solutionCells1[key];
                                    if (letter.isFirst) {
                                        const startDot = document.createElement('div');
                                        startDot.className = 'dir-start';
                                        cell.appendChild(startDot);
                                    }
                                    if (letter.isLast) {
                                        const endDot = document.createElement('div');
                                        endDot.className = 'dir-end';
                                        cell.appendChild(endDot);
                                    }
                                }
                                
                                gridElement1.appendChild(cell);
                            }
                        }
                        
                        page.appendChild(gridElement1);
                        
                        const wordList1 = document.createElement('div');
                        wordList1.className = 'word-list';
                        wordList1.innerHTML = `<strong>Words found:</strong><br>${puzzle.words.join(', ')}`;
                        page.appendChild(wordList1);
                        
                        // Add direction key
                        const directionKey1 = document.createElement('div');
                        directionKey1.className = 'solution-key';
                        directionKey1.innerHTML = `
                            <div class="direction-key">
                                <div class="direction-indicator">
                                    <div class="start"></div>
                                    <div class="end"></div>
                                </div>
                                <span>Word direction indicators</span>
                            </div>
                            <div>Black dot = word start, Circle = word end</div>
                        `;
                        page.appendChild(directionKey1);
                    }
                    
                    // Second puzzle
                    if (puzzles[i+1]) {
                        const divider = document.createElement('hr');
                        divider.style.margin = '20px 0';
                        page.appendChild(divider);
                        
                        const puzzle = puzzles[i+1];
                        
                        const header2 = document.createElement('div');
                        header2.className = 'puzzle-title';
                        const topicText2 = puzzle.topic ? `: ${puzzle.topic}` : '';
                        header2.textContent = `Puzzle #${i+2} Solution${topicText2}`;
                        page.appendChild(header2);
                        
                        const gridElement2 = document.createElement('div');
                        gridElement2.className = 'wordsearch-grid';
                        gridElement2.style.gridTemplateColumns = `repeat(${puzzle.cols}, 1fr)`;
                        gridElement2.style.marginBottom = '30px';
                        
                        const solutionCells2 = {};
                        puzzle.placedWords.forEach(word => {
                            word.letters.forEach(letter => {
                                const key = `${letter.row}-${letter.col}`;
                                solutionCells2[key] = letter;
                            });
                        });
                        
                        for (let row = 0; row < puzzle.rows; row++) {
                            for (let col = 0; col < puzzle.cols; col++) {
                                const cell = document.createElement('div');
                                cell.className = 'wordsearch-cell';
                                cell.textContent = puzzle.grid[row][col];
                                
                                const key = `${row}-${col}`;
                                if (solutionCells2[key] !== undefined) {
                                    const highlight = document.createElement('div');
                                    highlight.className = 'solution-highlight';
                                    cell.appendChild(highlight);
                                    
                                    const letter = solutionCells2[key];
                                    if (letter.isFirst) {
                                        const startDot = document.createElement('div');
                                        startDot.className = 'dir-start';
                                        cell.appendChild(startDot);
                                    }
                                    if (letter.isLast) {
                                        const endDot = document.createElement('div');
                                        endDot.className = 'dir-end';
                                        cell.appendChild(endDot);
                                    }
                                }
                                
                                gridElement2.appendChild(cell);
                            }
                        }
                        
                        page.appendChild(gridElement2);
                        
                        const wordList2 = document.createElement('div');
                        wordList2.className = 'word-list';
                        wordList2.innerHTML = `<strong>Words found:</strong><br>${puzzle.words.join(', ')}`;
                        page.appendChild(wordList2);
                        
                        // Add direction key
                        const directionKey2 = document.createElement('div');
                        directionKey2.className = 'solution-key';
                        directionKey2.innerHTML = `
                            <div class="direction-key">
                                <div class="direction-indicator">
                                    <div class="start"></div>
                                    <div class="end"></div>
                                </div>
                                <span>Word direction indicators</span>
                            </div>
                            <div>Black dot = word start, Circle = word end</div>
                        `;
                        page.appendChild(directionKey2);
                    }
                    
                    pages.push(page);
                }
            }
            
            return pages;
        }
        
        // Generate all puzzles
        function generatePuzzles() {
            bookPreview.innerHTML = '';
            
            const puzzleCount = parseInt(document.getElementById('puzzleCount').value);
            const wordsPerPuzzle = parseInt(wordsPerPuzzleInput.value);
            const gridRows = parseInt(gridRowsInput.value);
            const gridCols = parseInt(gridColsInput.value);
            generatedPuzzles = [];
            
            // Parse custom topics
            parseCustomTopics();
            
            // Use custom words or default words
            const allWords = customWords.length > 0 ? customWords : DEFAULT_WORDS;
            
            // Add cover page
            bookPreview.appendChild(createCoverPage());
            
            // Generate puzzles
            for (let i = 0; i < puzzleCount; i++) {
                // Shuffle and select words
                const shuffledWords = [...allWords].sort(() => 0.5 - Math.random());
                const selectedWords = shuffledWords.slice(0, Math.min(wordsPerPuzzle, allWords.length));
                
                // Select topic (cycle through available topics or use null if none)
                const topic = customTopics.length > 0 ? customTopics[i % customTopics.length] : null;
                
                // Generate puzzle
                const puzzle = generateWordSearch(selectedWords, topic, gridRows, gridCols);
                generatedPuzzles.push(puzzle);
                
                // Add to preview
                bookPreview.appendChild(renderWordSearch(puzzle, i + 1));
            }
            
            // Add solution pages
            const solutionPages = createSolutionPages(generatedPuzzles);
            solutionPages.forEach(page => {
                bookPreview.appendChild(page);
            });
        }
        
        // Export to PDF
        async function exportToPdf() {
            if (generatedPuzzles.length === 0) {
                alert('Please generate puzzles first!');
                return;
            }
            
            const pdf = new jsPDF({
                unit: 'in',
                format: [6, 9]
            });
            
            // Get all pages (cover, puzzles, solutions)
            const pages = document.querySelectorAll('.page-preview');
            
            for (let i = 0; i < pages.length; i++) {
                if (i > 0) {
                    pdf.addPage([6, 9], 'portrait');
                }
                
                const page = pages[i];
                const canvas = await html2canvas(page, {
                    scale: 3,
                    useCORS: true
                });
                
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', 0, 0, 6, 9);
            }
            
            pdf.save('word-search-book-with-solutions.pdf');
        }
        
        // Initialize
        updateWordListPreview();
    </script>
</body>
</html>
